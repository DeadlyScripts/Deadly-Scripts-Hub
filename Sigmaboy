

local OrionLib = {}
OrionLib.__index = OrionLib

-- Storage for registered theme objects: { {Object = <UIObject>, Type = "Main"/"Secondary"/"Accent"/"Text"}, ... }
local themeObjects = {}

-- Current theme data (will be replaced by Themes entries)
local Theme = {
    Main = Color3.fromRGB(35, 35, 35),
    Secondary = Color3.fromRGB(45, 45, 45),
    Accent = Color3.fromRGB(0, 170, 255),
    Text = Color3.fromRGB(255, 255, 255)
}

-- Built-in theme definitions
local Themes = {
    ["Dark"] = {
        Main = Color3.fromRGB(35,35,35),
        Secondary = Color3.fromRGB(45,45,45),
        Accent = Color3.fromRGB(0,170,255),
        Text = Color3.fromRGB(255,255,255)
    },
    ["Light"] = {
        Main = Color3.fromRGB(240,240,240),
        Secondary = Color3.fromRGB(225,225,225),
        Accent = Color3.fromRGB(0,120,255),
        Text = Color3.fromRGB(25,25,25)
    },
    ["Neon"] = {
        Main = Color3.fromRGB(10,10,10),
        Secondary = Color3.fromRGB(18,18,18),
        Accent = Color3.fromRGB(0,255,170),
        Text = Color3.fromRGB(0,255,170)
    },
    ["Purple"] = {
        Main = Color3.fromRGB(20,6,30),
        Secondary = Color3.fromRGB(36,12,52),
        Accent = Color3.fromRGB(170,0,255),
        Text = Color3.fromRGB(230,200,255)
    },
    ["Red"] = {
        Main = Color3.fromRGB(30,6,6),
        Secondary = Color3.fromRGB(50,12,12),
        Accent = Color3.fromRGB(255,50,50),
        Text = Color3.fromRGB(255,200,200)
    }
}

-- Persistence (simple save/load using writefile/readfile if available)
local function SaveThemeChoice(name)
    if typeof(name) ~= "string" then return end
    pcall(function()
        if writefile then
            if not isfolder then
                -- some environments may not have isfolder; skip
            end
            writefile("DS_TESTING_theme.txt", name)
        end
    end)
end

local function LoadThemeChoice()
    local ok, val = pcall(function()
        if isfile and isfile("DS_TESTING_theme.txt") then
            return readfile("DS_TESTING_theme.txt")
        end
    end)
    if ok and val and Themes[val] then
        return val
    end
    return nil
end

-- Apply the current Theme table to all registered objects
local function ApplyTheme()
    for _, entry in ipairs(themeObjects) do
        local obj = entry.Object
        local typ = entry.Type
        if not obj then
            -- skip if destroyed
        else
            if typ == "Main" then
                if obj:IsA("ImageLabel") or obj:IsA("ImageButton") then
                    -- image objects don't get background color normally; skip
                else
                    pcall(function() obj.BackgroundColor3 = Theme.Main end)
                end
            elseif typ == "Secondary" then
                pcall(function() obj.BackgroundColor3 = Theme.Secondary end)
            elseif typ == "Accent" then
                pcall(function()
                    if obj:IsA("UIStroke") then
                        obj.Color = Theme.Accent
                    elseif obj:IsA("TextLabel") or obj:IsA("TextBox") or obj:IsA("TextButton") then
                        -- accent for text-like objects -> change Background or Stroke if any
                        if obj.BackgroundColor3 then obj.BackgroundColor3 = Theme.Accent end
                    else
                        obj.BackgroundColor3 = Theme.Accent
                    end
                end)
            elseif typ == "Text" then
                pcall(function() obj.TextColor3 = Theme.Text end)
            end
        end
    end
end

-- Public API: change theme by name (must exist in Themes)
function OrionLib:ChangeTheme(name)
    if not name or typeof(name) ~= "string" then return false end
    if Themes[name] then
        Theme = Themes[name]
        ApplyTheme()
        SaveThemeChoice(name)
        return true
    end
    return false
end

-- Public API: register a UI object to be theme-managed under a specific type
-- types: "Main", "Secondary", "Accent", "Text"
function OrionLib:RegisterThemeObject(uiObject, typ)
    if not uiObject or typeof(typ) ~= "string" then return end
    table.insert(themeObjects, {Object = uiObject, Type = typ})
    -- apply current theme color immediately to the newly added object
    pcall(function()
        if typ == "Main" then uiObject.BackgroundColor3 = Theme.Main end
        if typ == "Secondary" then uiObject.BackgroundColor3 = Theme.Secondary end
        if typ == "Accent" then
            if uiObject:IsA("UIStroke") then uiObject.Color = Theme.Accent
            else uiObject.BackgroundColor3 = Theme.Accent end
        end
        if typ == "Text" and (uiObject:IsA("TextLabel") or uiObject:IsA("TextBox") or uiObject:IsA("TextButton")) then
            uiObject.TextColor3 = Theme.Text
        end
    end)
end

-- Helper to create UI objects with registration
local function NewFrame(props, parent, regtype)
    local f = Instance.new("Frame")
    for k,v in pairs(props or {}) do pcall(function() f[k] = v end) end
    f.Parent = parent
    if regtype then OrionLib:RegisterThemeObject(f, regtype) end
    return f
end

local function NewLabel(props, parent, regtype)
    local l = Instance.new("TextLabel")
    for k,v in pairs(props or {}) do pcall(function() l[k] = v end) end
    l.Parent = parent
    if regtype then OrionLib:RegisterThemeObject(l, regtype) end
    return l
end

local function NewButton(props, parent, regtype)
    local b = Instance.new("TextButton")
    for k,v in pairs(props or {}) do pcall(function() b[k] = v end) end
    b.Parent = parent
    if regtype then OrionLib:RegisterThemeObject(b, regtype) end
    return b
end

-- Create a basic window and return a minimal window API (MakeTab etc.)
function OrionLib:MakeWindow(config)
    config = config or {}
    local screen = Instance.new("ScreenGui")
    screen.Name = config.Name or "DS_Window"
    screen.ResetOnSpawn = false
    screen.Parent = game:GetService("CoreGui")

    local main = NewFrame({Size = UDim2.new(0, 640, 0, 360), Position = UDim2.new(0.5, -320, 0.5, -180), AnchorPoint = Vector2.new(0.5,0.5)}, screen, "Main")
    main.Name = "DSMainWindow"
    main.ClipsDescendants = true

    -- topbar
    local topbar = NewFrame({Size = UDim2.new(1,0,0,48), Position = UDim2.new(0,0,0,0)}, main, "Secondary")
    local title = NewLabel({Text = config.Name or "DS Window", Size = UDim2.new(1,-20,1,0), Position = UDim2.new(0,10,0,0), BackgroundTransparency = 1, Font = Enum.Font.GothamBold, TextSize = 20}, topbar, "Text")

    -- content area
    local content = Instance.new("Frame")
    content.Name = "ContentArea"
    content.Size = UDim2.new(1, -160, 1, -48)
    content.Position = UDim2.new(0, 160, 0, 48)
    content.Parent = main
    OrionLib:RegisterThemeObject(content, "Main")

    -- left tab holder
    local tabHolder = Instance.new("Frame")
    tabHolder.Size = UDim2.new(0, 160, 1, -48)
    tabHolder.Position = UDim2.new(0, 0, 0, 48)
    tabHolder.Parent = main
    OrionLib:RegisterThemeObject(tabHolder, "Secondary")

    -- layout for tabs list
    local UIList = Instance.new("UIListLayout", tabHolder)
    UIList.Padding = UDim.new(0,6)
    UIList.SortOrder = Enum.SortOrder.LayoutOrder
    UIList.Parent = tabHolder

    local function MakeTab(tabConfig)
        local tabbtn = Instance.new("TextButton")
        tabbtn.Size = UDim2.new(1, -10, 0, 36)
        tabbtn.Position = UDim2.new(0, 8, 0, 8)
        tabbtn.Parent = tabHolder
        tabbtn.Text = tabConfig.Name or "Tab"
        tabbtn.Font = Enum.Font.GothamSemibold
        tabbtn.TextSize = 14
        OrionLib:RegisterThemeObject(tabbtn, "Text")
        OrionLib:RegisterThemeObject(tabbtn, "Secondary")

        local page = Instance.new("Frame", content)
        page.Size = UDim2.new(1, -20, 1, -20)
        page.Position = UDim2.new(0,10,0,10)
        page.Visible = false
        OrionLib:RegisterThemeObject(page, "Main")

        tabbtn.MouseButton1Click:Connect(function()
            -- hide all pages
            for _, child in ipairs(content:GetChildren()) do
                if child:IsA("Frame") then child.Visible = false end
            end
            page.Visible = true
        end)

        -- API for adding elements into page
        local PageAPI = {}
        function PageAPI:AddLabel(text)
            local lbl = NewLabel({Text = text or "", Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 0), BackgroundTransparency = 1, Font = Enum.Font.Gotham, TextSize = 14}, page, "Text")
            return lbl
        end
        function PageAPI:AddButton(btnInfo)
            btnInfo = btnInfo or {}
            local btn = NewButton({Text = btnInfo.Text or "Button", Size = UDim2.new(0, 120, 0, 34), Position = UDim2.new(0, 10, 0, 30)}, page, "Accent")
            if btnInfo.Callback then btn.MouseButton1Click:Connect(btnInfo.Callback) end
            return btn
        end
        function PageAPI:AddToggle(toggleInfo)
            toggleInfo = toggleInfo or {}
            toggleInfo.Default = toggleInfo.Default or false
            local holder = NewFrame({Size = UDim2.new(1,-20,0,34), Position = UDim2.new(0,10,0,70)}, page, "Secondary")
            local lbl = NewLabel({Text = toggleInfo.Text or "Toggle", Size = UDim2.new(1,-60,1,0), Position = UDim2.new(0,8,0,0), BackgroundTransparency = 1, Font = Enum.Font.Gotham, TextSize = 14}, holder, "Text")
            local btn = NewButton({Text = toggleInfo.Default and "ON" or "OFF", Size = UDim2.new(0,50,0,28), Position = UDim2.new(1,-58,0,3)}, holder, "Accent")
            local state = toggleInfo.Default
            btn.MouseButton1Click:Connect(function()
                state = not state
                btn.Text = state and "ON" or "OFF"
                if toggleInfo.Callback then toggleInfo.Callback(state) end
            end)
            return {Holder = holder, Button = btn, Label = lbl}
        end

        return PageAPI
    end

    -- expose public API
    local windowAPI = {
        MakeTab = MakeTab,
        Root = main,
        ScreenGui = screen
    }

    return windowAPI
end

-- When required, auto-load previously saved theme choice
local loaded = LoadThemeChoice()
if loaded then OrionLib:ChangeTheme(loaded) end

-- Provide access to Themes table for scripts
function OrionLib:GetThemeNames()
    local t = {}
    for k,_ in pairs(Themes) do table.insert(t,k) end
    table.sort(t)
    return t
end

-- Provide method to add custom theme definitions
function OrionLib:AddTheme(name, themeTable)
    if typeof(name) ~= "string" then return false end
    if type(themeTable) ~= "table" then return false end
    Themes[name] = themeTable
    return true
end

-- Return library
return OrionLib
